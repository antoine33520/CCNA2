# TP 1

## I. Gather informations

* Liste des cartes réseaux :

```bash
[root@tp1 ~]# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 00:0c:29:be:09:90 brd ff:ff:ff:ff:ff:ff
    inet 192.168.195.129/24 brd 192.168.195.255 scope global dynamic noprefixroute ens33
       valid_lft 1036sec preferred_lft 1036sec
    inet6 fe80::3708:f512:3298:2ec2/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
3: ens34: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 00:0c:29:be:09:9a brd ff:ff:ff:ff:ff:ff
    inet 192.168.235.136/24 brd 192.168.235.255 scope global dynamic noprefixroute ens34
       valid_lft 1036sec preferred_lft 1036sec
    inet6 fe80::6b39:c30f:fbca:a4b3/64 scope link noprefixroute
       valid_lft forever preferred_lft forever

```

* Bail DHCP :

```bash
[root@tp1 ~]# cat /var/lib/dhclient/dhclient.leases
default-duid "\000\004\353\350\3165nFO\014\203)\306a?\004<\246";
lease {
  interface "ens34";
  fixed-address 192.168.235.138;
  option subnet-mask 255.255.255.0;
  option routers 192.168.235.2;
  option dhcp-lease-time 1800;
  option dhcp-message-type 5;
  option domain-name-servers 192.168.235.2;
  option dhcp-server-identifier 192.168.235.254;
  option broadcast-address 192.168.235.255;
  option domain-name "localdomain";
  renew 4 2019/09/26 07:55:50;
  rebind 4 2019/09/26 08:10:24;
  expire 4 2019/09/26 08:14:09;
}
lease {
  interface "ens33";
  fixed-address 192.168.195.131;
  option subnet-mask 255.255.255.0;
  option dhcp-lease-time 1800;
  option dhcp-message-type 5;
  option domain-name-servers 192.168.195.1;
  option dhcp-server-identifier 192.168.195.254;
  option broadcast-address 192.168.195.255;
  option domain-name "localdomain";
  renew 4 2019/09/26 07:55:59;
  rebind 4 2019/09/26 08:10:27;
  expire 4 2019/09/26 08:14:12;
}
```

* Table de routage :

```bash
[root@tp1 ~]# ip route
default via 192.168.235.2 dev ens34 proto dhcp metric 101
192.168.195.0/24 dev ens33 proto kernel scope link src 192.168.195.131 metric 100
192.168.235.0/24 dev ens34 proto kernel scope link src 192.168.235.138 metric 101

```

La première ligne indique la route par défaut pour celles qui ne sont pas définient statiquement.
Les deux autres lignes sont présentes car ce ceux les réseaux auxquels les cartes sont physiquement reliées.

* Ports en écoute :

```bash
[root@tp1 ~]# ss -l -t -u
Netid       State         Recv-Q        Send-Q                        Local Address:Port                 Peer Address:Port
udp         UNCONN        0             0                     192.168.235.136%ens34:bootpc                    0.0.0.0:*
udp         UNCONN        0             0                     192.168.195.129%ens33:bootpc                    0.0.0.0:*
udp         UNCONN        0             0                                   0.0.0.0:bootpc                    0.0.0.0:*
tcp         LISTEN        0             128                                 0.0.0.0:ssh                       0.0.0.0:*
tcp         LISTEN        0             128                                    [::]:ssh                          [::]:*
```

* ARp :

```bash
[root@tp1 ~]# ip n
192.168.235.2 dev ens34 lladdr 00:50:56:eb:89:06 REACHABLE
192.168.235.1 dev ens34 lladdr 00:50:56:c0:00:08 REACHABLE
```

* DNS :

```bash
[root@tp1 ~]# cat /etc/resolv.conf
# Generated by NetworkManager
search localdomain tp
nameserver 192.168.235.2
nameserver 192.168.195.1

[root@tp1 ~]# yum install bind-utils -y
[root@tp1 ~]# dig www.reddit.com

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-17.P2.el8_0.1 <<>> www.reddit.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 4530
;; flags: qr rd ra; QUERY: 1, ANSWER: 5, AUTHORITY: 13, ADDITIONAL: 7

;; QUESTION SECTION:
;www.reddit.com.                        IN      A

;; ANSWER SECTION:
www.reddit.com.         5       IN      CNAME   reddit.map.fastly.net.
reddit.map.fastly.net.  5       IN      A       151.101.65.140
reddit.map.fastly.net.  5       IN      A       151.101.1.140
reddit.map.fastly.net.  5       IN      A       151.101.129.140
reddit.map.fastly.net.  5       IN      A       151.101.193.140

;; AUTHORITY SECTION:
net.                    5       IN      NS      b.gtld-servers.net.
net.                    5       IN      NS      l.gtld-servers.net.
net.                    5       IN      NS      k.gtld-servers.net.
net.                    5       IN      NS      i.gtld-servers.net.
net.                    5       IN      NS      a.gtld-servers.net.
net.                    5       IN      NS      j.gtld-servers.net.
net.                    5       IN      NS      f.gtld-servers.net.
net.                    5       IN      NS      d.gtld-servers.net.
net.                    5       IN      NS      g.gtld-servers.net.
net.                    5       IN      NS      e.gtld-servers.net.
net.                    5       IN      NS      m.gtld-servers.net.
net.                    5       IN      NS      h.gtld-servers.net.
net.                    5       IN      NS      c.gtld-servers.net.

;; ADDITIONAL SECTION:
a.gtld-servers.net.     5       IN      A       192.5.6.30
a.gtld-servers.net.     5       IN      AAAA    2001:503:a83e::2:30
m.gtld-servers.net.     5       IN      A       192.55.83.30
m.gtld-servers.net.     5       IN      AAAA    2001:501:b1f9::30
j.gtld-servers.net.     5       IN      A       192.48.79.30
j.gtld-servers.net.     5       IN      AAAA    2001:502:7094::30
k.gtld-servers.net.     5       IN      A       192.52.178.30

;; Query time: 6 msec
;; SERVER: 192.168.235.2#53(192.168.235.2)
;; WHEN: Thu Sep 26 10:26:04 CEST 2019
;; MSG SIZE  rcvd: 500
```

* Firewall :

```bash
[root@tp1 ~]# systemctl status firewalld
● firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; vendor preset: enabled)
   Active: active (running) since Thu 2019-09-26 10:25:30 CEST; 3min 2s ago
     Docs: man:firewalld(1)
 Main PID: 819 (firewalld)
    Tasks: 2 (limit: 11375)
   Memory: 36.7M
   CGroup: /system.slice/firewalld.service
           └─819 /usr/libexec/platform-python -s /usr/sbin/firewalld --nofork --nopid

Sep 26 10:25:29 tp1.tp systemd[1]: Starting firewalld - dynamic firewall daemon...
Sep 26 10:25:30 tp1.tp systemd[1]: Started firewalld - dynamic firewall daemon.

[root@tp1 ~]# firewall-cmd --list-interfaces
ens33 ens34

[root@tp1 ~]# firewall-cmd --list-ports

[root@tp1 ~]# firewall-cmd --list-services
cockpit dhcpv6-client ssh

[root@tp1 ~]# nft list table filter
table ip filter {
        chain INPUT {
                type filter hook input priority 0; policy accept;
        }

        chain FORWARD {
                type filter hook forward priority 0; policy accept;
        }

        chain OUTPUT {
                type filter hook output priority 0; policy accept;
        }
}
```

* Changement IP :

```bash
[root@tp1 ~]# vi /etc/sysconfig/network-scripts/ifcfg-ens33

TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=none
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=ens33
UUID=d2a66942-f2a9-4828-aa36-5e32681ff2fb
DEVICE=ens33
ONBOOT=yes
IPV6_PRIVACY=no
IPADDR=192.168.5.10
PREFIX=24
```

* Nouvelle carte :

```bash
[root@tp1 ~]# vi /etc/sysconfig/network-scripts/ifcfg-ens37

HWADDR=00:0C:29:BE:09:A4
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=dhcp
IPADDR=192.168.6.11
PREFIX=24
GATEWAY=192.168.6.254
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=ens37
UUID=4d529f00-1638-33cb-afa3-51f43ff49148
ONBOOT=yes
AUTOCONNECT_PRIORITY=-999
```

* Bonding :

```bash
[root@tp1 ~]# vi /etc/sysconfig/network-scripts/ifcfg-ens37

HWADDR=00:0C:29:BE:09:A4
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=none
IPADDR=192.168.5.11
PREFIX=24
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=ens37
UUID=4d529f00-1638-33cb-afa3-51f43ff49148
ONBOOT=yes
AUTOCONNECT_PRIORITY=-999
```

```bash
[root@tp1 ~]# dnf install teamd -y

[root@tp1 ~]# nmcli connection show
NAME   UUID                                  TYPE      DEVICE
ens33  d2a66942-f2a9-4828-aa36-5e32681ff2fb  ethernet  ens33  
ens34  50bdbe70-a6e7-4671-ac44-9d4384095f44  ethernet  ens34  
ens37  4d529f00-1638-33cb-afa3-51f43ff49148  ethernet  ens37  

[root@tp1 ~]# nmcli connection delete 4d529f00-1638-33cb-afa3-51f43ff49148
Connection 'ens37' (4d529f00-1638-33cb-afa3-51f43ff49148) successfully deleted.
[root@tp1 ~]# nmcli connection delete d2a66942-f2a9-4828-aa36-5e32681ff2fb
Connection 'ens33' (d2a66942-f2a9-4828-aa36-5e32681ff2fb) successfully deleted.

[root@tp1 ~]# nmcli device status
DEVICE  TYPE      STATE                                  CONNECTION
ens34   ethernet  connected                              ens34
ens33   ethernet  connecting (getting IP configuration)  Wired connection 2
ens37   ethernet  connecting (getting IP configuration)  Wired connection 1
lo      loopback  unmanaged                              --

[root@tp1 ~]# nmcli connection add type team con-name team0 ifname team0 \
>   config '{ "runner": {"name": "loadbalance"}, "link_watch": {"name": "ethtool"}}'
Connection 'team0' (ea9b0be2-d40e-4a26-851f-cbb15361f113) successfully added.

[root@tp1 ~]# nmcli con mod team0 ipv4.addresses 192.168.5.10/24
[root@tp1 ~]# nmcli con mod team0 ipv4.method manual
[root@tp1 ~]# nmcli con mod team0 connection.autoconnect yes

[root@tp1 ~]# nmcli con add type team-slave con-name team0-slave0 ifname ens33 master team0
Connection 'team0-slave0' (7bf73d86-4fa0-42ed-a339-3005e8314621) successfully added.
[root@tp1 ~]# nmcli con add type team-slave con-name team0-slave1 ifname ens37 master team0
Connection 'team0-slave1' (c6a971ac-b7c0-4842-9ceb-9823cf34837a) successfully added.

[root@tp1 ~]# nmcli connection up team0
Connection successfully activated (master waiting for slaves) (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/39)

[root@tp1 ~]# nmcli connection show
NAME                UUID                                  TYPE      DEVICE
ens34               50bdbe70-a6e7-4671-ac44-9d4384095f44  ethernet  ens34  
team0               ea9b0be2-d40e-4a26-851f-cbb15361f113  team      team0  
team0-slave0        7bf73d86-4fa0-42ed-a339-3005e8314621  ethernet  ens33  
team0-slave1        c6a971ac-b7c0-4842-9ceb-9823cf34837a  ethernet  ens37  
Wired connection 1  4d529f00-1638-33cb-afa3-51f43ff49148  ethernet  --
Wired connection 2  e97787fa-1971-3fb2-8872-e9a7f278c1de  ethernet  --

[root@tp1 ~]# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel master team0 state UP group default qlen 1000
    link/ether 00:0c:29:be:09:90 brd ff:ff:ff:ff:ff:ff
3: ens34: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 00:0c:29:be:09:9a brd ff:ff:ff:ff:ff:ff
    inet 192.168.235.136/24 brd 192.168.235.255 scope global dynamic noprefixroute ens34
       valid_lft 1276sec preferred_lft 1276sec
    inet6 fe80::6b39:c30f:fbca:a4b3/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
4: ens37: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel master team0 state UP group default qlen 1000
    link/ether 00:0c:29:be:09:90 brd ff:ff:ff:ff:ff:ff
6: team0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 00:0c:29:be:09:90 brd ff:ff:ff:ff:ff:ff
    inet 192.168.5.10/24 brd 192.168.5.255 scope global noprefixroute team0
       valid_lft forever preferred_lft forever
    inet6 fe80::891f:292d:d57d:4258/64 scope link noprefixroute
       valid_lft forever preferred_lft forever

```

* SSH :

```bash
[root@tp1 ~]# vi /etc/ssh/sshd_config
...
Port 2222
...
PermitRootLogin without-password
...

[root@tp1 ~]# systemctl restart sshd


[root@patron ~]# ssh root@192.168.5.10 -p 2222 -i id_rsa
```

Lien vers la capture Wireshark [ici](./ssh_cap.pcapng).

## Routage
